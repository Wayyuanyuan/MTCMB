from make_answer.chat.chat_invoker import ChatInvoker


def tcm_msdd(prompt_type:int,data: dict, llm: ChatInvoker) -> dict:
    zero_shot_prompt = f'''
        请你根据以下临床信息，进行中医的辨证辨病，输出对应的中医证型、疾病。
        ##输出格式：
        "证型":[],
        "疾病":""
        ##注意：
        1.严格使用医学专业表达
        2.证型表项用数组形式保存，疾病表项以字符串形式返回。特别注意保存证型的数组每个元素只保存一个证型。
        3.输出格式与信息抽取的表单一致，以json格式返回，不要输出其它格式，禁用markdown格式。
        4.只完成表单，不需要给出解释。
        请从以下患者的临床信息中进行诊断，完成上述表单：{data["disease_case"]}
    '''
    few_shot_prompt = f'''
        请你根据以下临床信息，进行中医的辨证辨病，输出对应的中医证型、疾病。
        ##输出格式：
        "证型":[],
        "疾病":
        ##注意：
        1.严格使用医学专业表达。
        2.证型表项用数组形式保存，疾病表项以字符串形式返回。特别注意保存证型的数组每个元素只保存一个证型。
        3.输出格式与信息抽取的表单一致，以json格式返回，不要输出其它格式，禁用markdown格式。
        4.只完成表单，不需要给出解释。
        ##请参考下面的示例：
        示例一：
        【临床信息】：
        "性别": "女", "职业": "退（离）休人员", "年龄": "84岁", "婚姻": "已婚", "病史陈述者": "家属", "发病节气": "白露", "主诉": "右足趾间糜烂6月余。", "症状": "患者右足第2、4趾局部干黑坏死，右足第3、4趾趾间糜烂，疼痛严重，纳眠差，二便调。", "中医望闻切诊": "中医望闻切诊：表情自然，面色红润，形体正常,动静姿态，语气清,气息平；无异常气味,舌红，苔薄黄，脉弦滑。", "病史": "现病史，患者于8年前无明显诱因出现双下肢发凉、怕冷，于当地医院治疗，后于我院就诊，诊为“闭塞性动脉硬化症”，6年前，患者左足第3趾出现干黑坏死，疼痛明显，于当地医院治疗后效果不佳，转入我院治疗，2015-03-05于我院行左下肢动脉造影+球囊扩张成形术，术后症状明显好转，遂出院，出院2月后，左足内侧出现溃烂、疼痛，再次入我院治疗，2015-06-05于我院行左股部截肢术，症状好转后出院，1年前患者右足第4趾出现局部干黑，右足第1、2趾及第3、4趾趾间糜烂，于我院住院治疗，期间行右下肢动脉造影+球囊扩张成形术，术后好转出院，6月前患者右足第2趾出现干黑，右足第3、4趾趾间糜烂，今为求进一步系统治疗，特于我院就诊，门诊以“下肢动脉硬化闭塞症伴坏疽”收入院，既往史，否认其他慢性疾病史，否认肝炎、结核等传染病史，预防接种史不详，2015-03-05于我院行左下肢动脉造影+球囊扩张成形术，2015-06-05于我院行左股部截肢术，2019-12-09于我院行右下肢动脉造影+球囊扩张成形术，否认重大外伤史，否认输血史，自述磺胺类药物过敏、否认其他接触物过敏史，个人史，久居本地，无疫水、疫源接触史，吸烟史40年，2盒/日，少量饮酒，无放射线物质接触史，否认麻醉毒品等嗜好，否认冶游史，否认食物过敏史，否认传染病史，婚育史，适龄婚育，育有1女2子，配偶因肺心病去世，月经史，已绝经，家族史，子女体健，否认家族性遗传病史。", "体格检查": "生命体征体温：36.2℃ 脉搏：76次/分 呼吸：16次/分 血压：120/66mmHg VTE（Caprini）评分：4分，中危。", "辅助检查": "暂缺。" 
        【答案】：
        "证型": "痰热蕴结证", "疾病": "心悸病"
        示例二：
        【临床信息】：
        "性别": "男", "职业": "退休", "年龄": "76岁", "婚姻": "已婚", "病史陈述者": "患者本人及家属", "发病节气": "小满", "主诉": "阵发性头晕1天。", "症状": "头晕较前缓解，无头痛，无视物旋转，无耳聋耳鸣，无恶心呕吐，无言语不利及肢体活动不利，无晕厥黒曚，发病以来纳眠差，二便可。", "中医望闻切诊": "中医望闻切诊：表情自然，面色红润，形体正常,动静姿态，语气清,气息平；无异常气味,舌淡，苔白，脉弦。", "病史": "现病史，患者1天前无明显原因出现头晕，呈阵发性，每次持续数分钟至半小时不定，发作时伴视物旋转，恶心呕吐，呕吐物为胃内容物，无头痛，无耳聋耳鸣，无言语不利及肢体活动不利，无晕厥黒曚，家属急送来诊，急诊紧急完善颅脑CT及磁共振检查，诊为“脑梗死”，收住院，既往史，既往房颤病史3年，现口服华法林2.5mg抗凝，昨日查凝血INR1.18，否认高血压史、否认糖尿病等慢性疾病病史，否认肝炎、否认结核等传染病史，预防接种史不详，否认手术史、否认重大外伤史，否认输血史，否认药物过敏史、否认其他接触物过敏史，个人史，生于久居本地，无疫水、疫源接触史，无嗜酒史，无吸烟史，无放射线物质接触史，否认麻醉毒品等嗜好，否认冶游史，否认食物过敏史，否认传染病史，婚育史，适龄婚育，育有1女，家族史，否认家族性遗传病史。", "体格检查": "生命体征体温：36.3℃ 脉搏：64次/分 呼吸：18次/分 血压：116/82mmHg VTE评分：1分", "辅助检查": "暂无。"
        【答案】：
        "证型": "气滞血瘀证", "疾病": "眩晕病"
        #请你参考以上示例，从以下患者的临床信息中进行诊断，生成证型、疾病，完成上述表单：{data["disease_case"]}
    '''
    cot_prompt = f'''
        请你根据以下临床信息，进行中医的辨证辨病，输出对应的中医证型、疾病。
        ##输出格式：
        "证型":[],
        "疾病":
        ##注意：
        1.严格使用医学专业表达。
        2.证型表项用数组形式保存，疾病表项以字符串形式返回。特别注意保存证型的数组每个元素只保存一个证型。
        3.输出格式与信息抽取的表单一致，以json格式返回，不要输出其它格式，禁用markdown格式。
        4.只完成表单，不需要给出解释。
        ##请参考下面的示例：
        示例一：
        【临床信息】：
        "性别": "女", "职业": "退（离）休人员", "年龄": "84岁", "婚姻": "已婚", "病史陈述者": "家属", "发病节气": "白露", "主诉": "右足趾间糜烂6月余。", "症状": "患者右足第2、4趾局部干黑坏死，右足第3、4趾趾间糜烂，疼痛严重，纳眠差，二便调。", "中医望闻切诊": "中医望闻切诊：表情自然，面色红润，形体正常,动静姿态，语气清,气息平；无异常气味,舌红，苔薄黄，脉弦滑。", "病史": "现病史，患者于8年前无明显诱因出现双下肢发凉、怕冷，于当地医院治疗，后于我院就诊，诊为“闭塞性动脉硬化症”，6年前，患者左足第3趾出现干黑坏死，疼痛明显，于当地医院治疗后效果不佳，转入我院治疗，2015-03-05于我院行左下肢动脉造影+球囊扩张成形术，术后症状明显好转，遂出院，出院2月后，左足内侧出现溃烂、疼痛，再次入我院治疗，2015-06-05于我院行左股部截肢术，症状好转后出院，1年前患者右足第4趾出现局部干黑，右足第1、2趾及第3、4趾趾间糜烂，于我院住院治疗，期间行右下肢动脉造影+球囊扩张成形术，术后好转出院，6月前患者右足第2趾出现干黑，右足第3、4趾趾间糜烂，今为求进一步系统治疗，特于我院就诊，门诊以“下肢动脉硬化闭塞症伴坏疽”收入院，既往史，否认其他慢性疾病史，否认肝炎、结核等传染病史，预防接种史不详，2015-03-05于我院行左下肢动脉造影+球囊扩张成形术，2015-06-05于我院行左股部截肢术，2019-12-09于我院行右下肢动脉造影+球囊扩张成形术，否认重大外伤史，否认输血史，自述磺胺类药物过敏、否认其他接触物过敏史，个人史，久居本地，无疫水、疫源接触史，吸烟史40年，2盒/日，少量饮酒，无放射线物质接触史，否认麻醉毒品等嗜好，否认冶游史，否认食物过敏史，否认传染病史，婚育史，适龄婚育，育有1女2子，配偶因肺心病去世，月经史，已绝经，家族史，子女体健，否认家族性遗传病史。", "体格检查": "生命体征体温：36.2℃ 脉搏：76次/分 呼吸：16次/分 血压：120/66mmHg VTE（Caprini）评分：4分，中危。", "辅助检查": "暂缺。" 
        【推理过程】：
        1.症状表现：主诉与症状提示“右足趾间糜烂、干黑坏死、疼痛严重”，可见热毒或瘀阻。纳眠差提示内热或心神不宁。
        2.舌脉特征：舌红、苔薄黄：属热象，可能为实热内蕴。脉弦滑：提示痰湿与热邪互结，或瘀阻不畅。
        3.疾病过程：有长期“闭塞性动脉硬化症”病史，表现为肢体坏死、反复糜烂溃烂，多次截肢，符合“心悸病”中“血脉瘀阻”范畴。虽然外显在肢体，但病位可归于血脉，且与心主血脉之理论相应。
        4.证型分析：多次动脉阻塞，局部红肿、溃烂、坏死，可见湿热下注或痰热阻络。舌红苔黄、脉滑，为痰热内蕴、阻遏血脉之象。
        5.证型判定：结合局部坏死、苔黄、脉滑，判断为“痰热蕴结证”。
        6.疾病归类：虽然患者表现为肢体病变，但结合病因病机与中医病名对照，符合“心悸病”之“痰热扰心、血脉瘀阻”型。
        【答案】：
        "证型": "痰热蕴结证", "疾病": "心悸病"
        示例二：
        【临床信息】：
        "性别": "男", "职业": "退休", "年龄": "76岁", "婚姻": "已婚", "病史陈述者": "患者本人及家属", "发病节气": "小满", "主诉": "阵发性头晕1天。", "症状": "头晕较前缓解，无头痛，无视物旋转，无耳聋耳鸣，无恶心呕吐，无言语不利及肢体活动不利，无晕厥黒曚，发病以来纳眠差，二便可。", "中医望闻切诊": "中医望闻切诊：表情自然，面色红润，形体正常,动静姿态，语气清,气息平；无异常气味,舌淡，苔白，脉弦。", "病史": "现病史，患者1天前无明显原因出现头晕，呈阵发性，每次持续数分钟至半小时不定，发作时伴视物旋转，恶心呕吐，呕吐物为胃内容物，无头痛，无耳聋耳鸣，无言语不利及肢体活动不利，无晕厥黒曚，家属急送来诊，急诊紧急完善颅脑CT及磁共振检查，诊为“脑梗死”，收住院，既往史，既往房颤病史3年，现口服华法林2.5mg抗凝，昨日查凝血INR1.18，否认高血压史、否认糖尿病等慢性疾病病史，否认肝炎、否认结核等传染病史，预防接种史不详，否认手术史、否认重大外伤史，否认输血史，否认药物过敏史、否认其他接触物过敏史，个人史，生于久居本地，无疫水、疫源接触史，无嗜酒史，无吸烟史，无放射线物质接触史，否认麻醉毒品等嗜好，否认冶游史，否认食物过敏史，否认传染病史，婚育史，适龄婚育，育有1女，家族史，否认家族性遗传病史。", "体格检查": "生命体征体温：36.3℃ 脉搏：64次/分 呼吸：18次/分 血压：116/82mmHg VTE评分：1分", "辅助检查": "暂无。"
        【推理过程】：
        1.症状与主诉分析：患者主诉“阵发性头晕”，持续时间为“数分钟至半小时”，伴“视物旋转、恶心呕吐”，符合“眩晕病”的典型表现。虽目前“头晕较前缓解”，但初期表现仍指向中医“眩晕”的范围。
        2.现代诊断对照：颅脑检查明确诊断为“脑梗死”，提示存在脑部气血运行障碍。患有“房颤”，有形成血瘀、血栓的潜在机制，加重脑部瘀阻。
        3.望闻切诊分析：舌淡、苔白：反映气血不足或运行不畅。脉弦：提示气机郁结，常与情志、气滞或瘀阻有关。
        4.病因病机归纳：老年人，基础疾病为房颤，诱发脑梗，与血瘀密切相关；又因突发、反复发作，伴气机紊乱之象，判断为“气滞血瘀”；此证型常见于中医“眩晕病”中“瘀阻清窍”型。
        5.证型判断：综合舌脉（舌淡、苔白、脉弦）与症状（头晕、视物旋转、恶心呕吐）；结合现代诊断脑梗死、既往房颤、老年体质，推断“气滞血瘀”阻于清窍为主要病机。
        6.疾病判断：中医将突发性头晕、旋转、恶心归为“眩晕病”，病位在脑，病因多为痰、风、瘀等；本例以瘀血为主，证属“眩晕病”。
        【答案】：
        "证型": "气滞血瘀证", "疾病": "眩晕病"
        #请你参考以上思考方式，从以下患者的临床信息中进行诊断，生成证型、疾病，完成上述表单：{data["disease_case"]}
    '''

    match prompt_type:
        case 0:
            prompt = zero_shot_prompt
        case 1:
            prompt = few_shot_prompt
        case 2:
            prompt = cot_prompt
        case _:
            prompt = ""
    response = llm.chat(prompt)
    data["answer"] = response

    return data
