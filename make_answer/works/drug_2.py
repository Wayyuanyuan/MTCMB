import re

from make_answer.chat.chat_invoker import ChatInvoker


def drug_2(prompt_type:int,data: dict, llm: ChatInvoker) -> dict:
    zero_shot_prompt = f'''以下是一道单选题，有A、B、C、D 四个备选答案，请从中选择一个最佳答案。
                #注意：只返回选项字母序号即可，不需要解释，禁止返回其他内容。题目：{data['question']}选项：{str(data['options'])}'''
    few_shot_prompt = f'''
    以下是一道考题，有A、B、C、D 四个备选答案，请从中选择一个最佳答案。
    #注意：只返回选项字母序号即可，不需要解释，禁止返回其他内容。
    ##请参考以下示例：
    #示例一：
    【问题】：以下哪种中药材属于“有大毒”？
    【选项】：A. 土荆皮; B. 制川乌; C. 土鳖虫; D. 山豆根
    【答案】：B
    
    #示例二：
    【问题】：孕妇禁用的中药材是以下哪种？
    【选项】：A. 胆南星; B. 土鳖虫; C. 艾叶; D. 半夏
    【答案】：B
    
    #示例三：
    【问题】：以下哪种药材的毒性成分含马兜铃酸？
    【选项】：A. 马钱子; B. 细辛; C. 朱砂; D. 硫黄
    【答案】：B
    ##请参考以上示例，回答下面的问题。注意：最终输出只能为A、B、C、D中的一个，只返回答案字母选项，禁止返回其他内容。题目：{data['question']}。选项：{str(data['options'])}
    '''
    cot_prompt = f'''
    以下是一道考题，有A、B、C、D 四个备选答案，请从中选择一个最佳答案。
    #注意：只返回选项字母序号即可，不需要解释，禁止返回其他内容。
    ##请参考以下示例：
    #示例一：
    【问题】：以下哪种中药材属于“有大毒”？
    【选项】：A. 土荆皮; B. 制川乌; C. 土鳖虫; D. 山豆根
    【推理过程】：
    1.中药按照毒性分类一般为“无毒、小毒、有毒、有大毒”。
    2.土荆皮虽然具有一定毒性，但多用于外用，属“有毒”而非“有大毒”。
    3.制川乌来源于乌头类药材，尽管经过炮制，但仍具有剧毒，其主要毒性成分为乌头碱，被明确定义为“有大毒”药材。
    4.土鳖虫主要作用是破血通经，并无显著毒性。
    5.山豆根具有一定的寒性和苦味，用于清热解毒，也不属“有大毒”之列。
    6.因此，正确答案是毒性最强的“制川乌”。
    【答案】：B
    
    #示例二：
    【问题】：孕妇禁用的中药材是以下哪种？
    【选项】：A. 胆南星; B. 土鳖虫; C. 艾叶; D. 半夏
    【推理过程】：
    1.孕妇用药需谨慎，特别是活血化瘀、破血通经类药物多为禁忌。
    2.胆南星为燥湿化痰药，虽有毒但不主攻血分，非孕妇禁忌药。
    3.土鳖虫具有强力破血逐瘀作用，传统中医理论中属于“破血下行”类药物，容易导致流产，因此为孕妇禁用。
    4.艾叶反而是安胎常用药，可温经止血，对孕妇安全。
    5.半夏虽有毒，但炮制后用于化痰止呕，孕妇慎用但非绝对禁忌。
    6.因此，具有致流产风险的“土鳖虫”为正确答案。
    【答案】：B
    
    #示例三：
    【问题】：以下哪种药材的毒性成分含马兜铃酸？
    【选项】：A. 马钱子; B. 细辛; C. 朱砂; D. 硫黄
    【推理过程】：
    1.马兜铃酸是一类明确的肾毒性、致癌性成分，存在于部分马兜铃科植物中。
    2.马钱子的毒性来自士的宁与番木鳖碱，与马兜铃酸无关。
    3.细辛（特别是关木通类植物）属于马兜铃科，可能含马兜铃酸，尤其未炮制或使用根部等部分时更需警惕。
    4.朱砂的毒性来源于汞，硫黄属于矿物药，也无马兜铃酸。
    5.因此，正确答案是“细辛”。
    【答案】：B
    ##请参考以上思考方式，回答下面的问题。注意：最终输出只能为A、B、C、D中的一个，只返回答案字母选项，禁止返回其他内容。题目：{data['question']}。选项：{str(data['options'])}
    '''

    match prompt_type:
        case 0:
            prompt = zero_shot_prompt
        case 1:
            prompt = few_shot_prompt
        case 2:
            prompt = cot_prompt
        case _:
            prompt = ""
    response = llm.chat(prompt)

    # 直接匹配 A、B、C、D 四个选项（不区分大小写）
    extract_choice = re.compile(r".*?([A-Da-d]).*", re.DOTALL)

    # 从 response 中提取第一个匹配的选项字母（转为大写）
    match = extract_choice.match(response)
    data["answer"] = match.group(1).upper() if match else ""

    return data
