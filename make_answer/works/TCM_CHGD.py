from make_answer.chat.chat_invoker import ChatInvoker


def tcm_chgd(prompt_type:int,data: dict, llm: ChatInvoker) -> dict:
    zero_shot_prompt = f'''请严格按照中医标准术语，从下面的医患对话中精准提取信息，生成标准的医案，要求是结构化JSON数据。表单如下：
        ##表单内容
        中医疾病诊断：
        中医证候诊断：
        中医辨病辨证依据：含病因病机分析
        中医治法：
        方剂名称：
        药物组成：不需要给出剂量。
        ##注意
        1.若医患对话中未涉及相关内容，请填充“无”。
        2.禁用口语化表达，严格使用医学专业表达。
        3.输出格式与信息抽取的表单一致，不要输出其它格式，禁用markdown格式。
        4.表项用字符串形式，不需要数组格式。
        请从以下医患对话中提取信息，完成上述表单：{data["dialogue"]}
'''
    few_shot_prompt = f'''
        请从下面的医患对话中精准提取信息，严格按照中医标准术语生成规范的医案，要求是结构化JSON数据。表单如下：
        ## 表单内容
        中医疾病诊断：
        中医证候诊断：
        中医辨病辨证依据：含病因病机分析
        中医治法：
        方剂名称：
        药物组成：不需要给出剂量。
        ## 注意
        1.若医患对话中未涉及相关内容，请填充“无”。
        2.禁用口语化表达，严格使用医学专业表达。
        3.输出格式与信息抽取的表单一致，不要输出其它格式，禁用markdown格式。
        4.表项用字符串形式，不需要数组格式。
        
        # 请参考下面示例：
        一.医患对话：
        医生：姜先生哪里不舒服？慢慢说。  
        患者：大夫，我这手脚关节又沉又疼两年了，这两个月特别厉害。尤其早上起来手指头僵得跟木头似的，得活动个把小时才能缓过来。  
        医生：具体是哪些关节难受？摸摸看有没有肿的地方？  
        患者：手腕、膝盖这些大关节发胀，手指中间这截也肿得圆鼓鼓的，像泡了水的萝卜。阴天下雨时骨头缝里直冒寒气，裹着厚被子都不顶用。  
        医生：疼痛是固定在一处还是到处窜？遇热会舒服些吗？  
        患者：疼起来就死死钉在关节里，拿热毛巾焐着能稍微松快点。您看我这手，现在摸东西都发木，跟隔了层棉花似的。  
        医生：平时做什么工作？最近有没有受寒？  
        患者：在冷库当搬运工，两个月前连着加班，那寒气直往骨头里钻。现在连爬楼梯都费劲，膝盖跟灌了铅一样沉。  
        医生：饮食怎么样？大便粘马桶吗？  
        患者：胃口倒还行，就是吃了生黄瓜这类凉菜容易拉肚子。大便总擦不干净，您不说我还没注意，确实老粘马桶。  
        医生：舌头伸出来看看...舌苔白厚腻，像盖了层雪。手放上来把脉...脉象缓而无力，像是水流过沙地。你这是风寒湿邪困在关节了，湿气尤其重，所以关节像泡在水里似的肿胀发沉。  
        患者：那该怎么治啊？  
        医生：先开七剂薏苡仁汤化湿通络，苍术、羌活这些药能把关节里的水气抽出来，桂枝像小太阳帮你驱寒。记得熬药时加三片生姜。  
        医生：特别注意这三条：第一，冷库工作要戴加厚护膝；第二，冬瓜、啤酒这些生湿的东西千万别碰；第三，每天睡前用艾叶煮水泡脚二十分钟。等关节不肿了，教你几个舒筋活络的导引动作。  
        患者：记住了，这次一定严格照办。您看需要复诊吗？  
        医生：服药后如果晨僵缩短到半小时内，舌苔变薄了就过来调方子。要是遇到回南天，把方子里的薏苡仁加到30克先备着。
        二、答案：
        "中医疾病诊断": "痹证",
        "中医证候诊断": "风寒湿痹-着痹",
        "中医辨病辨证依据": "患者以肢体关节肿胀、疼痛，活动不利为主症，诊断为痹证。多个关节重着、酸痛、肿胀弥漫，麻木不仁，关节活动不利，阴雨天加重，舌质淡，苔白腻，脉濡缓，辨证为风寒湿痹着痹。感受风寒湿邪，留滞经脉，阻滞关节，闭阻气血，而引发本病。",
        "中医治法": "除湿通络，祛风散寒",
        "方剂名称": "薏苡仁汤加减",
        "药物组成": "薏苡仁、苍术、羌活、独活、防风、制川乌、麻黄、桂枝、当归、川芎、生姜、甘草"
        # 请你参考以上示例，从以下医患对话中提取信息，完成上述表单：{data["dialogue"]}
'''
    cot_prompt = f'''
    请从下面的医患对话中精准提取信息，严格按照中医标准术语生成规范的医案，要求是结构化JSON数据。表单如下：
    ## 表单内容
    中医疾病诊断：
    中医证候诊断：
    中医辨病辨证依据：含病因病机分析
    中医治法：
    方剂名称：
    药物组成：不需要给出剂量。
    ## 注意
    1.若医患对话中未涉及相关内容，请填充“无”。
    2.禁用口语化表达，严格使用医学专业表达。
    3.输出格式与信息抽取的表单一致，不要输出其它格式，禁用markdown格式。
    4.表项用字符串形式，不需要数组格式。
    
    # 请参考下面示例（含完整思维链推理过程）：
    一.医患对话：
    医生：姜先生哪里不舒服？慢慢说。  
    患者：大夫，我这手脚关节又沉又疼两年了，这两个月特别厉害。尤其早上起来手指头僵得跟木头似的，得活动个把小时才能缓过来。  
    医生：具体是哪些关节难受？摸摸看有没有肿的地方？  
    患者：手腕、膝盖这些大关节发胀，手指中间这截也肿得圆鼓鼓的，像泡了水的萝卜。阴天下雨时骨头缝里直冒寒气，裹着厚被子都不顶用。  
    医生：疼痛是固定在一处还是到处窜？遇热会舒服些吗？  
    患者：疼起来就死死钉在关节里，拿热毛巾焐着能稍微松快点。您看我这手，现在摸东西都发木，跟隔了层棉花似的。  
    医生：平时做什么工作？最近有没有受寒？  
    患者：在冷库当搬运工，两个月前连着加班，那寒气直往骨头里钻。现在连爬楼梯都费劲，膝盖跟灌了铅一样沉。  
    医生：饮食怎么样？大便粘马桶吗？  
    患者：胃口倒还行，就是吃了生黄瓜这类凉菜容易拉肚子。大便总擦不干净，您不说我还没注意，确实老粘马桶。  
    医生：舌头伸出来看看...舌苔白厚腻，像盖了层雪。手放上来把脉...脉象缓而无力，像是水流过沙地。你这是风寒湿邪困在关节了，湿气尤其重，所以关节像泡在水里似的肿胀发沉。  
    患者：那该怎么治啊？  
    医生：先开七剂薏苡仁汤化湿通络，苍术、羌活这些药能把关节里的水气抽出来，桂枝像小太阳帮你驱寒。记得熬药时加三片生姜。  
    医生：特别注意这三条：第一，冷库工作要戴加厚护膝；第二，冬瓜、啤酒这些生湿的东西千万别碰；第三，每天睡前用艾叶煮水泡脚二十分钟。等关节不肿了，教你几个舒筋活络的导引动作。  
    患者：记住了，这次一定严格照办。您看需要复诊吗？  
    医生：服药后如果晨僵缩短到半小时内，舌苔变薄了就过来调方子。要是遇到回南天，把方子里的薏苡仁加到30克先备着。
    二.思考过程：
    【症状采集与初步印象】
    1.主诉分析：患者陈述“手脚关节又沉又疼两年了，最近加重”，提示关节病程较长，为慢性病变。
    2.症状特征：
    “早上起来手指僵，得活动一小时才能缓解” → 晨僵，提示痹证中寒湿阻络的表现；
    “大关节发胀”“关节肿得像泡了水的萝卜” → 明显关节肿胀沉重感，为湿邪困阻之象；
    “阴天下雨骨头缝冒寒气”“热敷缓解” → 典型的风寒湿痹表现，寒重湿重；
    “发木，如隔棉花” → 气血运行不畅，脉络不通。
    【病因分析】
    3. 外感因素：“冷库搬运工”“连着加班” → 明确提示患者暴露于寒湿环境，属外邪风寒湿侵袭；
    4. 体质状态：患者大便粘滞不成形、怕寒、舌苔白厚腻、脉缓无力 → 属脾阳虚、湿邪内生体质，内外湿寒交困，加重病情。
    【中医诊断逻辑】
    5. 疾病诊断：
    依据“关节肿胀疼痛，活动不利，疼痛固定，遇寒加重”，诊断为痹证；
    6. 中医证候判定：
    “疼痛固定”“关节重着如裹”“阴雨天加重”“苔白腻、脉濡缓”，结合病因（风寒湿邪侵袭） → 属于风寒湿痹中的着痹证型；
    病因病机总结：风寒湿邪侵袭，留滞关节经络，气血运行受阻，导致关节疼痛、肿胀、沉重、麻木等症。
    【治疗方法与方药选择】
    7. 治法确定：根据风寒湿痹证，且以湿重为主，兼寒 → 治以除湿通络，祛风散寒；
    8. 方药选择：
    采用《医学心悟》“薏苡仁汤”加减；薏苡仁利湿通络，苍术燥湿健脾，羌活、独活、防风祛风胜湿止痛，桂枝、生姜温经散寒，麻黄助阳发散寒湿，川乌温经止痛，当归、川芎活血化瘀，甘草调和诸药。
    三、答案：
    "中医疾病诊断": "痹证",
    "中医证候诊断": "风寒湿痹-着痹",
    "中医辨病辨证依据": "患者以肢体关节肿胀、疼痛，活动不利为主症，诊断为痹证。多个关节重着、酸痛、肿胀弥漫，麻木不仁，关节活动不利，阴雨天加重，舌质淡，苔白腻，脉濡缓，辨证为风寒湿痹着痹。感受风寒湿邪，留滞经脉，阻滞关节，闭阻气血，而引发本病。",
    "中医治法": "除湿通络，祛风散寒",
    "方剂名称": "薏苡仁汤加减",
    "药物组成": "薏苡仁、苍术、羌活、独活、防风、制川乌、麻黄、桂枝、当归、川芎、生姜、甘草"
    # 请你参考以上思考方式，从以下医患对话中提取信息，完成上述表单：{data["dialogue"]}
'''

    match prompt_type:
        case 0:
            prompt = zero_shot_prompt
        case 1:
            prompt = few_shot_prompt
        case 2:
            prompt = cot_prompt
        case _:
            prompt = ""
    response = llm.chat(prompt)
    data["answer"] = response

    return data
